<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Certificate Download</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: auto;
      text-align: center;
    }
    img.logo {
      max-width: 150px;
      margin-bottom: 20px;
    }
    label, select, button {
      margin: 10px 0;
      display: block;
      width: 100%;
      padding: 10px;
      text-align: left;
    }
    button {
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <!-- ðŸ”½ Logo Added Here -->
  <img src="Picsart_25-05-09_19-10-01-372.png" alt="Site Logo" class="logo" />

  <h2>ðŸŽ“ Certificate Download Portal</h2>

  <label for="studentId">Select Student ID:</label>
  <select id="studentId">
    <option value="">-- Select ID --</option>
  </select>

  <label for="studentName">Select Student Name:</label>
  <select id="studentName" disabled>
    <option value="">-- Select Name --</option>
  </select>

  <button id="downloadBtn" disabled>Download Certificate</button>

  <script>
    async function fetchSheetData() {
      const sheetID = "1dtaiWm-uRnQ1nvO3eMPYQ01No_znv-5_YKP6-akKoPs";
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

      try {
        const response = await fetch(url);
        const text = await response.text();
        const jsonStr = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
        const json = JSON.parse(jsonStr);
        const rows = json?.table?.rows || [];

        const data = rows.map(r => ({
          id: r.c[0]?.v?.trim() || "",
          name: r.c[1]?.v?.trim() || "",
          file: r.c[2]?.v?.trim() || ""
        })).filter(item => item.id && item.name && item.file);

        console.log("Fetched Data:", data);
        return data;
      } catch (error) {
        console.error("Error fetching sheet data:", error);
        alert("Failed to fetch data from Google Sheet.");
        return [];
      }
    }

    function populateDropdowns(data) {
      const idSelect = document.getElementById("studentId");
      const nameSelect = document.getElementById("studentName");

      idSelect.innerHTML = '<option value="">-- Select ID --</option>';
      nameSelect.innerHTML = '<option value="">-- Select Name --</option>';
      nameSelect.disabled = true;

      window.certificateData = data;

      const uniqueIds = [...new Set(data.map(item => item.id))];

      uniqueIds.forEach(id => {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = id;
        idSelect.appendChild(opt);
      });

      idSelect.addEventListener("change", () => {
        const selectedId = idSelect.value;
        const filtered = data.filter(item => item.id === selectedId);

        nameSelect.innerHTML = '<option value="">-- Select Name --</option>';
        nameSelect.disabled = filtered.length === 0;

        filtered.forEach(item => {
          const opt = document.createElement("option");
          opt.value = item.name;
          opt.textContent = item.name;
          nameSelect.appendChild(opt);
        });

        toggleDownloadBtn();
      });

      nameSelect.addEventListener("change", toggleDownloadBtn);
    }

    function toggleDownloadBtn() {
      const idVal = document.getElementById("studentId").value;
      const nameVal = document.getElementById("studentName").value;
      document.getElementById("downloadBtn").disabled = !(idVal && nameVal);
    }

    function setupDownload() {
      document.getElementById("downloadBtn").addEventListener("click", () => {
        const id = document.getElementById("studentId").value.trim();
        const name = document.getElementById("studentName").value.trim();

        const matched = window.certificateData.find(i => i.id === id && i.name === name);
        if (!matched || !matched.file) {
          alert("Invalid selection or certificate file missing!");
          return;
        }

        const filePath = `certificates/${encodeURIComponent(matched.file)}`;
        const link = document.createElement("a");
        link.href = filePath;
        link.download = matched.file;
        link.target = "_blank";
        link.click();
      });
    }

    // Initialize the app
    (async () => {
      const data = await fetchSheetData();
      if (data.length) {
        populateDropdowns(data);
        setupDownload();
      }
    })();
  </script>
</body>
</html>
