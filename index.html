<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Certificate Download</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    label, select, button { margin: 10px 0; display: block; width: 100%; padding: 10px; }
    button { background-color: #007BFF; color: white; border: none; cursor: pointer; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <h2>ðŸŽ“ Certificate Download Portal</h2>

  <label for="studentId">Select Student ID:</label>
  <select id="studentId">
    <option value="">-- Select ID --</option>
  </select>

  <label for="studentName">Select Student Name:</label>
  <select id="studentName" disabled>
    <option value="">-- Select Name --</option>
  </select>

  <button id="downloadBtn" disabled>Download Certificate</button>

  <script>
    async function fetchSheetData() {
  const sheetID = "1dtaiWm-uRnQ1nvO3eMPYQ01No_znv-5_YKP6-akKoPs";
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

  const response = await fetch(url);
  const text = await response.text();

  // Extract JSON data between parentheses
  const jsonStr = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
  const json = JSON.parse(jsonStr);

  const rows = json.table.rows;

  // Map rows into usable data and filter out invalid rows
  return rows
    .map(row => ({
      id: row.c[0]?.v || "",
      name: row.c[2]?.v || "",
      file: row.c[3]?.v || ""
    }))
    .filter(item => item.id && item.name && item.file); // Ensure all fields present
}


    function populateDropdowns(data) {
      const idSelect = document.getElementById("studentId");
      const nameSelect = document.getElementById("studentName");

      idSelect.length = 1;  // Clear except placeholder
      nameSelect.length = 1;
      nameSelect.disabled = true;  // Disable name select until ID selected

      // Store data globally to use on change event
      window.certificateData = data;

      data.forEach(item => {
        const optId = document.createElement("option");
        optId.value = item.id;
        optId.textContent = item.id;
        idSelect.appendChild(optId);
      });

      idSelect.addEventListener("change", () => {
        const selectedId = idSelect.value;

        // Filter names matching selected ID
        const filteredNames = data.filter(item => item.id === selectedId);

        // Clear name dropdown & disable if no selection
        nameSelect.length = 1;
        nameSelect.disabled = filteredNames.length === 0;

        filteredNames.forEach(item => {
          const optName = document.createElement("option");
          optName.value = item.name;
          optName.textContent = item.name;
          nameSelect.appendChild(optName);
        });

        toggleDownloadBtn();
      });

      nameSelect.addEventListener("change", toggleDownloadBtn);
    }

    function toggleDownloadBtn() {
      const id = document.getElementById("studentId").value;
      const name = document.getElementById("studentName").value;
      document.getElementById("downloadBtn").disabled = !(id && name);
    }

    function setupDownload() {
      document.getElementById("downloadBtn").addEventListener("click", () => {
        const id = document.getElementById("studentId").value;
        const name = document.getElementById("studentName").value;

        const matched = window.certificateData.find(item => item.id === id && item.name === name);

        if (!matched || !matched.file) {
          alert("Invalid selection or certificate file missing!");
          return;
        }

        const link = document.createElement("a");
        link.href = `certificates/${matched.file}`;
        link.download = matched.file;
        link.target = "_blank";
        link.click();
      });
    }

    (async function init() {
      try {
        const data = await fetchSheetData();
        populateDropdowns(data);
        setupDownload();
      } catch (error) {
        console.error("Error fetching or processing data:", error);
        alert("Failed to load data. Please try again later.");
      }
    })();
  </script>
</body>
</html>
