<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Certificate Download</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    label, select, button { margin: 10px 0; display: block; width: 100%; padding: 10px; }
    button { background-color: #007BFF; color: white; border: none; cursor: pointer; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <h2>ðŸŽ“ Certificate Download Portal</h2>

  <label for="studentId">Select Student ID:</label>
  <select id="studentId">
    <option value="">-- Select ID --</option>
  </select>

  <label for="studentName">Student Name:</label>
  <input type="text" id="studentName" disabled style="width:100%; padding:10px;" />

  <button id="downloadBtn" disabled>Download Certificate</button>

  <script>
    async function fetchSheetData() {
      const sheetID = "1dtaiWm-uRnQ1nvO3eMPYQ01No_znv-5_YKP6-akKoPs";
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

      const response = await fetch(url);
      const text = await response.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));

      const rows = json.table.rows;

      // Remove header row (if present) or filter invalid rows
      return rows
        .filter(row => row.c[0]?.v && row.c[2]?.v && row.c[3]?.v) // Ensure all fields exist
        .map(row => ({
          id: row.c[0].v.trim(),
          name: row.c[2].v.trim(),
          file: row.c[3].v.trim()
        }));
    }

    function populateDropdown(data) {
      const idSelect = document.getElementById("studentId");
      idSelect.length = 1; // Keep placeholder

      data.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = item.id;
        idSelect.appendChild(opt);
      });
    }

    function setupInteractions(data) {
      const idSelect = document.getElementById("studentId");
      const nameInput = document.getElementById("studentName");
      const downloadBtn = document.getElementById("downloadBtn");

      idSelect.addEventListener("change", () => {
        const selectedId = idSelect.value;
        if (!selectedId) {
          nameInput.value = "";
          downloadBtn.disabled = true;
          return;
        }

        const matched = data.find(item => item.id === selectedId);
        if (matched) {
          nameInput.value = matched.name;
          downloadBtn.disabled = false;
        } else {
          nameInput.value = "";
          downloadBtn.disabled = true;
        }
      });

      downloadBtn.addEventListener("click", () => {
        const selectedId = idSelect.value;
        if (!selectedId) {
          alert("Please select a Student ID.");
          return;
        }

        const matched = data.find(item => item.id === selectedId);
        if (!matched || !matched.file) {
          alert("Invalid selection or certificate file missing!");
          return;
        }

        const link = document.createElement("a");
        link.href = `certificates/${matched.file}`;
        link.download = matched.file;
        link.target = "_blank";
        link.click();
      });
    }

    (async function init() {
      const data = await fetchSheetData();
      populateDropdown(data);
      setupInteractions(data);
    })();
  </script>
</body>
</html>

